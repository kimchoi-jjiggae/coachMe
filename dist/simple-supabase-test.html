<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Supabase Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üß™ Simple Supabase Test</h1>
    
    <div class="test">
        <h3>Step 1: Check Configuration</h3>
        <button onclick="checkConfig()">Check Config</button>
        <div id="configResult"></div>
    </div>
    
    <div class="test">
        <h3>Step 2: Test Basic Connection</h3>
        <button onclick="testConnection()">Test Connection</button>
        <div id="connectionResult"></div>
    </div>
    
    <div class="test">
        <h3>Step 3: Try to Save Test Entry</h3>
        <button onclick="saveTestEntry()">Save Test Entry</button>
        <div id="saveResult"></div>
    </div>
    
    <div class="test">
        <h3>Step 4: Check What's in Supabase</h3>
        <button onclick="checkSupabaseData()">Check Supabase Data</button>
        <div id="dataResult"></div>
    </div>

    <!-- Load the configuration files -->
    <script src="my-keys.js"></script>
    <script src="config.js"></script>
    
    <script>
        let supabase = null;
        let config = {};
        
        function checkConfig() {
            const result = document.getElementById('configResult');
            
            // Check MY_KEYS
            if (window.MY_KEYS?.SUPABASE_URL && window.MY_KEYS?.SUPABASE_ANON_KEY) {
                config.supabaseUrl = window.MY_KEYS.SUPABASE_URL;
                config.supabaseKey = window.MY_KEYS.SUPABASE_ANON_KEY;
                config.source = 'MY_KEYS';
            }
            // Check CONFIG
            else if (window.CONFIG?.SUPABASE_URL && window.CONFIG?.SUPABASE_ANON_KEY) {
                config.supabaseUrl = window.CONFIG.SUPABASE_URL;
                config.supabaseKey = window.CONFIG.SUPABASE_ANON_KEY;
                config.source = 'CONFIG';
            }
            // Check localStorage
            else {
                config.supabaseUrl = localStorage.getItem('supabaseUrl');
                config.supabaseKey = localStorage.getItem('supabaseKey');
                config.source = 'localStorage';
            }
            
            let html = '<div class="info">';
            html += `<p><strong>Source:</strong> ${config.source || 'Not found'}</p>`;
            html += `<p><strong>URL:</strong> ${config.supabaseUrl ? '‚úÖ Found' : '‚ùå Missing'}</p>`;
            html += `<p><strong>Key:</strong> ${config.supabaseKey ? '‚úÖ Found' : '‚ùå Missing'}</p>`;
            html += '</div>';
            
            if (config.supabaseUrl && config.supabaseKey) {
                html += '<div class="success">‚úÖ Configuration loaded successfully!</div>';
            } else {
                html += '<div class="error">‚ùå Configuration incomplete!</div>';
            }
            
            result.innerHTML = html;
        }
        
        async function testConnection() {
            const result = document.getElementById('connectionResult');
            result.innerHTML = '<div class="info">Testing connection...</div>';
            
            if (!config.supabaseUrl || !config.supabaseKey) {
                result.innerHTML = '<div class="error">‚ùå No configuration found. Run Step 1 first.</div>';
                return;
            }
            
            try {
                // Load Supabase client
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                supabase = createClient(config.supabaseUrl, config.supabaseKey);
                
                // Test basic connection
                const { data, error } = await supabase
                    .from('conversations')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    result.innerHTML = `<div class="error">‚ùå Connection failed: ${error.message}</div>`;
                } else {
                    result.innerHTML = '<div class="success">‚úÖ Connection successful!</div>';
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function saveTestEntry() {
            const result = document.getElementById('saveResult');
            result.innerHTML = '<div class="info">Saving test entry...</div>';
            
            if (!supabase) {
                result.innerHTML = '<div class="error">‚ùå No connection. Run Step 2 first.</div>';
                return;
            }
            
            try {
                const testEntry = {
                    id: 'test_' + Date.now(),
                    user_id: 'test_user_' + Date.now(),
                    user_message: 'This is a test entry from the diagnostic tool.',
                    ai_response: '',
                    date: new Date().toISOString(),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('conversations')
                    .insert([testEntry]);
                
                if (error) {
                    result.innerHTML = `<div class="error">‚ùå Save failed: ${error.message}</div>`;
                } else {
                    result.innerHTML = `<div class="success">‚úÖ Test entry saved! ID: ${testEntry.id}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Save error: ${error.message}</div>`;
            }
        }
        
        async function checkSupabaseData() {
            const result = document.getElementById('dataResult');
            result.innerHTML = '<div class="info">Checking Supabase data...</div>';
            
            if (!supabase) {
                result.innerHTML = '<div class="error">‚ùå No connection. Run Step 2 first.</div>';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('conversations')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) {
                    result.innerHTML = `<div class="error">‚ùå Query failed: ${error.message}</div>`;
                } else {
                    let html = `<div class="success">‚úÖ Found ${data.length} entries in Supabase:</div>`;
                    
                    if (data.length === 0) {
                        html += '<div class="info">No entries found in Supabase.</div>';
                    } else {
                        data.forEach((entry, index) => {
                            html += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 3px;">`;
                            html += `<strong>Entry ${index + 1}:</strong><br>`;
                            html += `ID: ${entry.id}<br>`;
                            html += `User ID: ${entry.user_id}<br>`;
                            html += `Message: ${entry.user_message.substring(0, 50)}...<br>`;
                            html += `Date: ${new Date(entry.date).toLocaleString()}`;
                            html += `</div>`;
                        });
                    }
                    
                    result.innerHTML = html;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Query error: ${error.message}</div>`;
            }
        }
        
        // Auto-run config check on load
        window.onload = function() {
            checkConfig();
        };
    </script>
</body>
</html>
